<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gerador de Arte • Rádio Amizade</title>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Roboto:ital,wght@0,700;1,700&family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0b0c; --panel:#121316; --ink:#eaeaea; --muted:#9aa3ad; --brand:#ffd400;
      --line:#23262d; --field:#0e1116; --ring:#2f5aff; --ring-alpha:0.35;
      --upload-h: 50px; /* altura do botão de upload */
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:linear-gradient(180deg,#0d0f13,#0b0b0c);
      color:var(--ink); font-family:"Roboto",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif
    }
    header{padding:30px; display:flex; align-items:center; gap:12px}
    header h1{font-size:24px; margin:0; font-weight:700; letter-spacing:.2px}

    .app{display:grid; grid-template-columns:420px 1fr; gap:20px; padding:0 24px 24px}
    @media (max-width: 980px){ .app{grid-template-columns:1fr} }

    .panel{
      background:var(--panel); border:1px solid var(--line); border-radius:18px;
      padding:18px 16px; box-shadow:0 10px 30px rgba(0,0,0,.25)
    }

    .field{margin:14px 8px}
    .field label{display:block; font-size:12px; color:var(--muted); margin-bottom:8px}
    .control{position:relative}

    .input, .textarea{
      width:100%; background:var(--field); color:var(--ink);
      border:1px solid #2a2f39; border-radius:12px;
      padding:14px 16px; font-size:15px; outline:none;
      transition:box-shadow .15s, border-color .15s;
    }
    .textarea{min-height:120px; resize:vertical; line-height:1.45}
    .input:focus, .textarea:focus, .upload-btn:focus-visible{
      border-color:rgba(47,90,255,.6);
      box-shadow:0 0 0 4px rgba(47,90,255,var(--ring-alpha));
    }

    /* ===== Upload (input invisível sobre o botão) ===== */
    .upload-wrap{
      position:relative;
      height:var(--upload-h);
    }
    .upload-input{
      position:absolute; inset:0; width:100%; height:100%;
      opacity:0; cursor:pointer; z-index:2;
    }
    .upload-btn{
      position:absolute; inset:0; z-index:1;
      display:flex; align-items:center; justify-content:center; /* centro perfeito */
      height:100%; padding:0; line-height:1;
      font-family:"Roboto",system-ui,-apple-system,Segoe UI,Arial,sans-serif;
      font-weight:700; font-size:18px;
      appearance:none; -webkit-appearance:none;

      background:linear-gradient(180deg,#171a22,#12151c);
      color:#e7edf5;
      border:1px solid #2a2f39;
      border-radius:16px;
      user-select:none;
      transition:border-color .15s, box-shadow .15s, transform .06s, background .15s;
      text-align:center; white-space:nowrap;
    }
    .upload-btn:hover{ border-color:#3a4150; background:#1a1e27 }
    .upload-btn:active{ transform:translateY(1px) }
    .upload-btn.is-dragover{
      border-color:var(--brand);
      box-shadow:0 0 0 4px rgba(255,212,0,.25);
    }
    .upload-btn .hint{ font:inherit; line-height:inherit; margin:0 }

    .btns{display:flex; gap:12px; margin:16px 8px 4px; flex-wrap:wrap}
    button{
      background:#1f2937; color:#f7fbff; border:1px solid #2a2f39;
      border-radius:12px; padding:14px 18px; font-weight:700; cursor:pointer; font-size:15px
    }
    button.primary{background:var(--brand); color:#151515; border-color:#d6b700}
    button:disabled{opacity:.5; cursor:not-allowed}

    .counter{margin-top:6px; font-size:12px; color:var(--muted); display:flex; justify-content:flex-end}
    .counter.over{color:#ff7676}

    .stage{
      background:#0b0c0e; border:1px solid var(--line); border-radius:18px;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      padding:18px; gap:12px
    }
    .stage .canvas-wrap{position:relative; border-radius:14px; overflow:hidden; background:#111}
    .ghost{font-size:13px; color:#9199a6}

    /* Rodapé (sem sublinhado) */
    .credits{
      text-align:left; font-size:12px; color:#8892a0; padding:10px 30px;
    }
    .credits a{ color:#8892a0; text-decoration:none }
    .credits a:hover{ color:#c2c8d0 }
  </style>
</head>
<body>
  <header></header>

  <div class="app">
    <section class="panel">
      <!-- Upload -->
      <div class="field">
        <label for="upload">Imagem de fundo</label>
        <div class="upload-wrap" id="dropZone">
          <input id="upload" class="upload-input" type="file" accept="image/*" />
          <button type="button" class="upload-btn" id="uploadBtn" aria-hidden="true">
            <span class="hint">Fazer upload da imagem</span>
          </button>
        </div>
      </div>

      <!-- Etiqueta -->
      <div class="field">
        <label for="destaque">Etiqueta</label>
        <div class="control">
          <input id="destaque" class="input" type="text" placeholder="Notícia" value="NOTÍCIA" maxlength="20" />
        </div>
        <div class="counter" id="destaqueCounter">0 / 20</div>
      </div>

      <!-- Manchete (quebra de linha permitida, mas NUNCA vazia) -->
      <div class="field">
        <label for="manchete">Manchete</label>
        <div class="control">
          <textarea id="manchete" class="textarea" placeholder="Digite a manchete..." maxlength="100"></textarea>
        </div>
        <div class="counter" id="mancheteCounter">0 / 100</div>
      </div>

      <div class="btns">
        <button id="download" class="primary" disabled>Baixar imagem</button>
      </div>
    </section>

    <section class="stage">
      <div class="canvas-wrap">
        <canvas id="canvas" width="1080" height="1350" style="width: 440px; height: auto; max-width: 100%; touch-action: none; cursor: grab;"></canvas>
      </div>
      <div class="ghost">Dica: arraste para reposicionar a foto.</div>
    </section>
  </div>

  <footer class="credits">
    Criado por <a href="https://vondoscht.com" target="_blank" rel="noopener">Gabriel Von Doscht</a>
  </footer>

  <script>
    // ===== Configuração rápida =====
    const CONFIG = { BOTTOM_MARGIN: 120, GAP_BETWEEN_BOX_AND_TEXT: 36 };
    const LIMITS = { destaque: 20, manchete: 100 };

    const $ = (q) => document.querySelector(q);
    const canvas = $('#canvas');
    let ctx = canvas.getContext('2d'); // reatribuído após DPR a cada render

    const els = {
      destaque: $('#destaque'),
      destaqueCounter: $('#destaqueCounter'),
      manchete: $('#manchete'),
      mancheteCounter: $('#mancheteCounter'),
      upload:   $('#upload'),
      uploadBtn: $('#uploadBtn'),
      dropZone: $('#dropZone'),
      download: $('#download')
    };

    // --- Fontes ---
    let fontsLoaded = false;
    async function ensureFonts(){
      if (fontsLoaded) return;
      try{
        await Promise.all([
          document.fonts.load('400 64px "Bebas Neue"'),
          document.fonts.load('700 italic 64px "Roboto"'),
          document.fonts.ready
        ]);
      }catch(e){}
      fontsLoaded = true;
    }

    // --- Overlay (pré-carregada 1x) ---
    const OVERLAY_SRC = 'overlay.png';
    let overlayImg = null;

    // ===== Estado da imagem de fundo + drag =====
    let bgURL = null;
    let bgImg = null; // Image()
    const bgState = { dw:0, dh:0, x:0, y:0, minX:0, maxX:0, minY:0, maxY:0 };

    function revokeBgURL(){ if (bgURL){ URL.revokeObjectURL(bgURL); bgURL = null; } }

    function computeCoverDims(img, W, H){
      const iw = img.naturalWidth || img.width;
      const ih = img.naturalHeight || img.height;
      const scale = Math.max(W / iw, H / ih);
      return { dw: Math.ceil(iw * scale), dh: Math.ceil(ih * scale) };
    }

    function centerAndClampBg(W, H){
      if(!bgImg) return;
      const { dw, dh } = computeCoverDims(bgImg, W, H);
      bgState.dw = dw; bgState.dh = dh;
      bgState.x = Math.floor((W - dw) / 2);
      bgState.y = Math.floor((H - dh) / 2);
      if (dw > W) { bgState.minX = W - dw; bgState.maxX = 0; } else { bgState.minX = bgState.maxX = bgState.x; }
      if (dh > H) { bgState.minY = H - dh; bgState.maxY = 0; } else { bgState.minY = bgState.maxY = bgState.y; }
    }

    function clamp(val, min, max){ return Math.min(max, Math.max(min, val)); }

    // ===== Helpers =====
    function wrapText(text, maxWidth){
      const words = (text||'').split(/\s+/); let line = '', lines=[];
      for(const w of words){
        const test = line ? line + ' ' + w : w;
        const m = ctx.measureText(test).width;
        if(m > maxWidth && line){ lines.push(line); line = w; }
        else line = test;
      }
      if(line) lines.push(line);
      return lines;
    }

    // Remove linhas vazias e quebra por largura
    function wrapWithoutEmptyLines(text, maxWidth){
      const raw = (text ?? '').split('\n').map(l => l.trim()).filter(Boolean);
      const out = [];
      for(const p of raw){ out.push(...wrapText(p, maxWidth)); }
      return out;
    }

    // ===== Render =====
    async function render(){
      await ensureFonts();

      const W = 1080, H = 1350;
      const dpr = window.devicePixelRatio || 1;
      canvas.width = W * dpr;
      canvas.height = H * dpr;

      ctx = canvas.getContext('2d');
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      ctx.clearRect(0,0,W,H);

      // 1) Fundo
      if(bgImg){
        if(!bgState.dw || !bgState.dh){ centerAndClampBg(W, H); }
        ctx.imageSmoothingQuality = 'high';
        ctx.drawImage(bgImg, bgState.x, bgState.y, bgState.dw, bgState.dh);
      } else {
        ctx.fillStyle = '#333'; ctx.fillRect(0,0,W,H);
        ctx.fillStyle = '#777'; ctx.font = '600 28px Poppins'; ctx.fillText('Envie uma foto de fundo', 28, 48);
      }

      // 2) Overlay
      if (overlayImg) ctx.drawImage(overlayImg, 0, 0, W, H);

      // 3) Textos
      const brand = '#FFD400';

      // Manchete (sem linhas vazias)
      const headline = (els.manchete.value || '');
      const HEADLINE_FONT_SIZE = 64;
      const HEADLINE_LEFT_PADDING = 80;
      const HEADLINE_RIGHT_PADDING = 80;
      const LINE_HEIGHT = Math.round(HEADLINE_FONT_SIZE * 1.24);
      ctx.fillStyle = '#fff';
      ctx.font = `700 italic ${HEADLINE_FONT_SIZE}px Roboto, system-ui, sans-serif`;
      ctx.textBaseline = 'alphabetic';

      const maxTextW = W - HEADLINE_LEFT_PADDING - HEADLINE_RIGHT_PADDING;
      const lines = wrapWithoutEmptyLines(headline, maxTextW).slice(0, 6);
      const L = Math.max(1, lines.length);
      const firstTextLine = lines[0] || 'Ag';
      const yFirstBaseline = H - CONFIG.BOTTOM_MARGIN - (L - 1) * LINE_HEIGHT;

      // Badge
      let badgeText = (els.destaque.value || '').toUpperCase().normalize('NFC');
      const BADGE_FONT_SIZE = 64;
      const BADGE_HEIGHT = 80;
      const BADGE_LETTER_SPACING = 4;
      const BADGE_LEFT_PADDING = 80;
      const BADGE_RIGHT_PADDING = 20;
      const OPTICAL_NUDGE_Y = 0;

      ctx.font = `400 ${BADGE_FONT_SIZE}px "Bebas Neue", Poppins, sans-serif`;
      ctx.textBaseline = 'alphabetic';
      const tWidth = textWidthWithSpacing(ctx, badgeText, BADGE_LETTER_SPACING);
      const badgeW = Math.min(W, Math.max(120, tWidth + BADGE_LEFT_PADDING + BADGE_RIGHT_PADDING));
      const badgeH = BADGE_HEIGHT;

      ctx.font = `700 italic ${HEADLINE_FONT_SIZE}px Roboto, system-ui, sans-serif`;
      const mHeadline = ctx.measureText(firstTextLine);
      const ascentHeadline = (mHeadline && mHeadline.actualBoundingBoxAscent !== undefined)
        ? mHeadline.actualBoundingBoxAscent
        : Math.round(HEADLINE_FONT_SIZE * 0.8);

      const firstLineTopY = yFirstBaseline - ascentHeadline;
      const badgeY = firstLineTopY - CONFIG.GAP_BETWEEN_BOX_AND_TEXT - badgeH;

      ctx.fillStyle = brand;
      ctx.fillRect(0, badgeY, badgeW, badgeH);

      ctx.fillStyle = '#111';
      ctx.font = `400 ${BADGE_FONT_SIZE}px "Bebas Neue", Poppins, sans-serif`;
      const refMetrics = ctx.measureText('H');
      const ascent  = refMetrics.actualBoundingBoxAscent ?? BADGE_FONT_SIZE * 0.8;
      const descent = refMetrics.actualBoundingBoxDescent ?? BADGE_FONT_SIZE * 0.2;
      const baselineY = Math.round(badgeY + (badgeH + ascent - descent)/2 + OPTICAL_NUDGE_Y);
      const textX = BADGE_LEFT_PADDING;
      fillTextWithSpacing(ctx, badgeText, textX, baselineY, BADGE_LETTER_SPACING);

      // Desenhar linhas (já sem vazias)
      ctx.fillStyle = '#fff';
      ctx.font = `700 italic ${HEADLINE_FONT_SIZE}px Roboto, system-ui, sans-serif`;
      let y = yFirstBaseline;
      for(const ln of lines){
        ctx.fillText(ln, HEADLINE_LEFT_PADDING, y);
        y += LINE_HEIGHT;
      }

      els.download.disabled = false;
    }

    // ===== Preview com RAF =====
    let rafId = 0;
    function scheduleRender(){
      if (rafId) cancelAnimationFrame(rafId);
      rafId = requestAnimationFrame(() => { rafId = 0; render(); });
    }

    // ===== Contadores e limites =====
    function updateCounter(el, counterEl, limit){
      const len = el.value.length;
      counterEl.textContent = `${len} / ${limit}`;
      counterEl.classList.toggle('over', len > limit);
    }
    function enforceLimit(el, limit){
      if (el.value.length > limit) el.value = el.value.slice(0, limit);
    }
    function handleLimitedInput(el, counterEl, limit){
      enforceLimit(el, limit);
      updateCounter(el, counterEl, limit);
      scheduleRender();
    }

    // ===== Sanitização da manchete (remove linhas vazias) =====
    function sanitizeHeadlineValue(){
      const lines = els.manchete.value
        .split('\n')
        .map(l => l.trim())
        .filter(Boolean);          // remove vazias
      els.manchete.value = lines.join('\n');
    }

    // Inicializa contadores
    updateCounter(els.destaque, els.destaqueCounter, LIMITS.destaque);
    updateCounter(els.manchete, els.mancheteCounter, LIMITS.manchete);

    // Listeners de texto
    els.destaque.addEventListener('input', () =>
      handleLimitedInput(els.destaque, els.destaqueCounter, LIMITS.destaque)
    );
    els.manchete.addEventListener('input', () => {
      sanitizeHeadlineValue(); // impede linhas vazias na origem
      handleLimitedInput(els.manchete, els.mancheteCounter, LIMITS.manchete);
    });

    // ===== Upload da foto (click/select) =====
    els.upload.addEventListener('change', async () => {
      const file = els.upload.files && els.upload.files[0];
      if (file){
        revokeBgURL();
        bgURL = URL.createObjectURL(file);
        bgImg = await loadImage(bgURL);
        if (bgImg) centerAndClampBg(1080, 1350);
        scheduleRender();
      } else {
        revokeBgURL();
        bgImg = null;
        scheduleRender();
      }
    });

    // ===== Drag-over highlight + drop-to-upload =====
    ['dragenter','dragover'].forEach(evt=>{
      els.dropZone.addEventListener(evt, e=>{
        e.preventDefault(); e.stopPropagation();
        els.uploadBtn.classList.add('is-dragover');
      });
    });
    ['dragleave','dragend','drop'].forEach(evt=>{
      els.dropZone.addEventListener(evt, e=>{
        e.preventDefault(); e.stopPropagation();
        els.uploadBtn.classList.remove('is-dragover');
      });
    });
    els.dropZone.addEventListener('drop', async (e)=>{
      e.preventDefault(); e.stopPropagation();
      const file = e.dataTransfer?.files?.[0];
      if (!file || !file.type?.startsWith('image/')) return;

      revokeBgURL();
      bgURL = URL.createObjectURL(file);
      bgImg = await loadImage(bgURL);
      if (bgImg) centerAndClampBg(1080, 1350);
      scheduleRender();
    });

    // ===== Download =====
    els.download.addEventListener('click', () => {
      const link = document.createElement('a');
      link.download = 'arte-manchete.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    });

    // ===== Drag (reposicionar imagem no canvas) =====
    let isDragging = false;
    let dragStart = { x: 0, y: 0 };
    let imgStart = { x: 0, y: 0 };

    function toCanvasCoords(clientX, clientY){
      const rect = canvas.getBoundingClientRect();
      const W = 1080, H = 1350;
      const x = (clientX - rect.left) * (W / rect.width);
      const y = (clientY - rect.top)  * (H / rect.height);
      return { x, y };
    }

    canvas.addEventListener('pointerdown', (e) => {
      if(!bgImg) return;
      canvas.setPointerCapture(e.pointerId);
      isDragging = true;
      canvas.style.cursor = 'grabbing';
      const p = toCanvasCoords(e.clientX, e.clientY);
      dragStart = p;
      imgStart = { x: bgState.x, y: bgState.y };
    });

    canvas.addEventListener('pointermove', (e) => {
      if(!isDragging || !bgImg) return;
      const p = toCanvasCoords(e.clientX, e.clientY);
      const dx = p.x - dragStart.x;
      const dy = p.y - dragStart.y;
      bgState.x = clamp(imgStart.x + dx, bgState.minX, bgState.maxX);
      bgState.y = clamp(imgStart.y + dy, bgState.minY, bgState.maxY);
      scheduleRender();
    });

    function endDrag(e){
      if(!isDragging) return;
      isDragging = false;
      canvas.style.cursor = 'grab';
      if (e && e.pointerId) {
        try { canvas.releasePointerCapture(e.pointerId); } catch(_) {}
      }
    }
    canvas.addEventListener('pointerup', endDrag);
    canvas.addEventListener('pointercancel', endDrag);
    canvas.addEventListener('pointerleave', endDrag);

    // ===== Boot =====
    (async function boot(){
      overlayImg = await loadImage(OVERLAY_SRC);
      scheduleRender();
    })();
  </script>
</body>
</html>
