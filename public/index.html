<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gerador de Arte — Alerta + Manchete (Overlay fixa)</title>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Roboto:ital,wght@0,700;1,700&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#0b0b0c; --panel:#121316; --ink:#eaeaea; --muted:#9aa3ad; --brand:#ffd400; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0d0f13,#0b0b0c);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{padding:20px 24px 8px;display:flex;align-items:center;gap:12px}
    header h1{font-size:18px;margin:0;font-weight:800;letter-spacing:.2px}
    .app{display:grid;grid-template-columns:360px 1fr;gap:18px;padding:0 24px 24px}
    @media (max-width: 980px){ .app{grid-template-columns:1fr} }
    .panel{background:var(--panel);border:1px solid #23262d;border-radius:16px;padding:16px 14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .panel h2{margin:4px 6px 12px;font-size:14px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.12em}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 6px 6px}
    input[type="text"], textarea{width:100%;border:1px solid #2a2f39;background:#0e1116;color:var(--ink);border-radius:10px;padding:10px 12px;font-size:14px;outline:none}
    textarea{min-height:110px;resize:vertical}
    .row{display:flex;gap:10px;align-items:center}
    .row > *{flex:1}
    .btns{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    button{background:#1f2937;color:#f7fbff;border:1px solid #2a2f39;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
    button.primary{background:var(--brand);color:#151515;border-color:#d6b700}
    button:disabled{opacity:.5;cursor:not-allowed}
    .stage{background:#0b0c0e;border:1px solid #23262d;border-radius:16px;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px;gap:12px}
    .stage .canvas-wrap{position:relative;border-radius:12px;overflow:hidden;background:#111}
    canvas{display:block}
    .ghost{font-size:13px;color:#9199a6}
    .note{font-size:12px;color:#8892a0}

    /* ===== Edição no preview (overlay HTML) ===== */
    .live-overlay{position:absolute;inset:0;pointer-events:none}
    .badge-edit, .headline-edit{position:absolute;pointer-events:auto;user-select:text;caret-color:#fff}
    .badge-edit{color:#111;white-space:nowrap;overflow:hidden}
    .badge-edit:focus{outline:2px dashed rgba(255,212,0,.6)}
    .headline-edit{color:#fff;white-space:pre-wrap;word-break:break-word}
    .headline-edit:focus{outline:2px dashed rgba(255,255,255,.3)}
  </style>
</head>
<body>
  <header>
    <svg width="26" height="26" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="11" stroke="#ffd400" stroke-width="2"/><path d="M12 6.5V13M12 17.5h.01" stroke="#ffd400" stroke-width="2" stroke-linecap="round"/></svg>
    <h1>Gerador de Arte — Alerta + Manchete (Overlay fixa)</h1>
  </header>

  <div class="app">
    <section class="panel">
      <h2>Conteúdo</h2>
      <label for="destaque">Texto do alerta (ex.: ALERTA)</label>
      <input id="destaque" type="text" placeholder="ALERTA" value="ALERTA" />

      <label for="manchete">Manchete</label>
      <textarea id="manchete" placeholder="Digite a manchete..."></textarea>

      <div class="row">
        <div>
          <label for="upload">Foto de fundo</label>
          <input id="upload" type="file" accept="image/*" />
        </div>
      </div>

      <div class="btns">
        <button id="render" class="primary">Atualizar preview</button>
        <button id="download" disabled>Baixar PNG</button>
        <button id="clear">Limpar</button>
      </div>
      <p class="note">Edição direta no preview: clique no <b>box amarelo</b> ou na <b>manchete</b> sobre a imagem e digite. O PNG sai em 1080×1350.</p>
      <p class="note">Coloque a sua overlay como <code>/public/overlay.png</code> (PNG transparente). Ela será aplicada acima da foto, e os textos acima dela.</p>
    </section>

    <section class="stage">
      <div class="canvas-wrap">
        <canvas id="canvas" width="1080" height="1350" style="width: 420px; height: auto; max-width: 100%;"></canvas>
        <div id="live" class="live-overlay">
          <div id="badgeEdit" class="badge-edit" contenteditable="true" spellcheck="false"></div>
          <div id="headlineEdit" class="headline-edit" contenteditable="true" spellcheck="false"></div>
        </div>
      </div>
      <div class="ghost">Clique no box/na manchete para editar no lugar. Depois baixe o PNG.</div>
    </section>
  </div>

  <script>
    // ===== Config geral =====
    const CONFIG = {
      BOTTOM_MARGIN: 120,              // distância da ÚLTIMA linha até a borda inferior
      GAP_BETWEEN_BOX_AND_TEXT: 36,    // distância entre fundo do box e TOPO da 1ª linha
      BADGE_FONT_SIZE: 64,
      BADGE_HEIGHT: 80,
      BADGE_LETTER_SPACING: 4,
      BADGE_LEFT_PADDING: 80,
      BADGE_RIGHT_PADDING: 20,
      HEADLINE_FONT_SIZE: 64,
      HEADLINE_LEFT_PADDING: 80,
      HEADLINE_RIGHT_PADDING: 80,
      HEADLINE_LINE_HEIGHT: 1.24
    };

    const $ = (q) => document.querySelector(q);
    const canvas = $('#canvas');
    const ctx = canvas.getContext('2d');

    const els = {
      destaque: $('#destaque'),
      manchete: $('#manchete'),
      upload:   $('#upload'),
      render:   $('#render'),
      download: $('#download'),
      clear:    $('#clear'),
      live:     $('#live'),
      badgeEdit: $('#badgeEdit'),
      headlineEdit: $('#headlineEdit')
    };

    // Fonts
    let fontsLoaded = false;
    async function ensureFonts(){
      if(fontsLoaded) return; try{
        await Promise.all([
          document.fonts.load(`400 ${CONFIG.BADGE_FONT_SIZE}px "Bebas Neue"`),
          document.fonts.load(`700 italic ${CONFIG.HEADLINE_FONT_SIZE}px Roboto`)
        ]);
        await document.fonts.ready; fontsLoaded = true;
      }catch(e){ fontsLoaded = true; }
    }

    // Assets
    const OVERLAY_SRC = 'overlay.png';
    let bgURL = null;

    els.upload.addEventListener('change', () => {
      if(els.upload.files && els.upload.files[0]){
        bgURL = URL.createObjectURL(els.upload.files[0]);
      } else bgURL = null;
      renderPreview();
    });

    // Helpers
    function drawCover(img, x, y, w, h){
      const iw = img.width, ih = img.height; const ir = iw/ih, r = w/h; let dw, dh, dx, dy;
      if(ir > r){ dh = h; dw = dh*ir; dx = x + (w-dw)/2; dy = y; }
      else { dw = w; dh = dw/ir; dx = x; dy = y + (h-dh)/2; }
      ctx.drawImage(img, dx, dy, dw, dh);
    }
    function wrapText(text, maxWidth){
      const words = (text||'').split(/\s+/); let line = '', lines=[];
      for(const w of words){ const test = line ? line + ' ' + w : w; const m = ctx.measureText(test).width; if(m > maxWidth && line){ lines.push(line); line = w; } else line = test; }
      if(line) lines.push(line); return lines;
    }
    function loadImage(url){ return new Promise((res)=>{ if(!url) return res(null); const img=new Image(); img.onload=()=>res(img); img.onerror=()=>res(null); img.src=url; }); }

    // ==== Layout computation (shared by preview + final render + overlay) ====
    function computeLayout(badgeText, headline){
      const W = 1080, H = 1350; // fixo
      // Headline metrics
      const HF = CONFIG.HEADLINE_FONT_SIZE; const HL = Math.round(HF * CONFIG.HEADLINE_LINE_HEIGHT);
      ctx.font = `700 italic ${HF}px Roboto, system-ui, sans-serif`;
      const lines = wrapText(headline, W - CONFIG.HEADLINE_LEFT_PADDING - CONFIG.HEADLINE_RIGHT_PADDING).slice(0,6);
      const L = Math.max(1, lines.length);
      const yFirstBaseline = H - CONFIG.BOTTOM_MARGIN - (L - 1) * HL;
      const mHeadline = ctx.measureText(lines[0] || 'Ag');
      const ascent = (mHeadline && mHeadline.actualBoundingBoxAscent !== undefined) ? mHeadline.actualBoundingBoxAscent : Math.round(HF * 0.8);
      const firstLineTop = yFirstBaseline - ascent;

      // Badge metrics
      const BF = CONFIG.BADGE_FONT_SIZE; const BH = CONFIG.BADGE_HEIGHT; const LS = CONFIG.BADGE_LETTER_SPACING;
      ctx.font = `400 ${BF}px "Bebas Neue", Poppins, sans-serif`;
      // measure width with letter-spacing
      let tWidth = 0; for(let i=0;i<badgeText.length;i++){ tWidth += ctx.measureText(badgeText[i]).width; if(i<badgeText.length-1) tWidth += LS; }
      const badgeW = Math.min(W, Math.max(120, tWidth + CONFIG.BADGE_LEFT_PADDING + CONFIG.BADGE_RIGHT_PADDING));
      const badgeY = firstLineTop - CONFIG.GAP_BETWEEN_BOX_AND_TEXT - BH;

      return { W,H, lines, HL, yFirstBaseline, firstLineTop, ascent, badgeW, badgeY };
    }

    // ===== Live overlay positioning =====
    function updateOverlay(){
      const badgeText = normalizeBadge(els.badgeEdit.textContent);
      const headline = els.headlineEdit.textContent || '';
      const L = computeLayout(badgeText, headline);
      const scale = canvas.getBoundingClientRect().width / canvas.width; // visual scale

      // badge styles
      els.badgeEdit.style.left = `${0}px`;
      els.badgeEdit.style.top = `${Math.round(L.badgeY * scale)}px`;
      els.badgeEdit.style.height = `${Math.round(CONFIG.BADGE_HEIGHT * scale)}px`;
      els.badgeEdit.style.width = `${Math.round(L.badgeW * scale)}px`;
      els.badgeEdit.style.fontFamily = '"Bebas Neue", sans-serif';
      els.badgeEdit.style.fontSize = `${CONFIG.BADGE_FONT_SIZE * scale}px`;
      els.badgeEdit.style.lineHeight = `${CONFIG.BADGE_HEIGHT * scale}px`; // centra vertical
      els.badgeEdit.style.letterSpacing = `${CONFIG.BADGE_LETTER_SPACING * scale}px`;
      els.badgeEdit.style.paddingLeft = `${CONFIG.BADGE_LEFT_PADDING * scale}px`;
      els.badgeEdit.style.paddingRight = `${CONFIG.BADGE_RIGHT_PADDING * scale}px`;

      // headline styles
      els.headlineEdit.style.left = `${Math.round(CONFIG.HEADLINE_LEFT_PADDING * scale)}px`;
      els.headlineEdit.style.top = `${Math.round(L.firstLineTop * scale)}px`;
      els.headlineEdit.style.width = `${Math.round((L.W - CONFIG.HEADLINE_LEFT_PADDING - CONFIG.HEADLINE_RIGHT_PADDING) * scale)}px`;
      els.headlineEdit.style.fontFamily = 'Roboto, system-ui, sans-serif';
      els.headlineEdit.style.fontSize = `${CONFIG.HEADLINE_FONT_SIZE * scale}px`;
      els.headlineEdit.style.fontWeight = '700';
      els.headlineEdit.style.fontStyle = 'italic';
      els.headlineEdit.style.lineHeight = `${L.HL * scale}px`;
    }

    function normalizeBadge(v){ return (v||'').replace(/\s+/g,' ').trim().toUpperCase(); }

    // ==== Renders ====
    async function renderPreview(){
      await ensureFonts();
      const W=1080,H=1350; canvas.width=W; canvas.height=H; ctx.clearRect(0,0,W,H);
      // bg
      if(bgURL){ const bg = await loadImage(bgURL); if(bg) drawCover(bg,0,0,W,H); } else { ctx.fillStyle='#333'; ctx.fillRect(0,0,W,H); }
      // overlay image
      const ov = await loadImage(OVERLAY_SRC); if(ov) ctx.drawImage(ov,0,0,W,H);
      // draw ONLY the yellow box (texts on HTML overlay)
      const badgeText = normalizeBadge(els.badgeEdit.textContent);
      const L = computeLayout(badgeText, els.headlineEdit.textContent || '');
      ctx.fillStyle = '#FFD400'; ctx.fillRect(0, L.badgeY, L.badgeW, CONFIG.BADGE_HEIGHT);
      els.download.disabled = false;
      updateOverlay();
    }

    async function renderFinalAndDownload(){
      await ensureFonts();
      const W=1080,H=1350; canvas.width=W; canvas.height=H; ctx.clearRect(0,0,W,H);
      // bg
      if(bgURL){ const bg = await loadImage(bgURL); if(bg) drawCover(bg,0,0,W,H); } else { ctx.fillStyle='#333'; ctx.fillRect(0,0,W,H); }
      // overlay
      const ov = await loadImage(OVERLAY_SRC); if(ov) ctx.drawImage(ov,0,0,W,H);
      // layout
      const badgeText = normalizeBadge(els.badgeEdit.textContent);
      const headline = els.headlineEdit.textContent || '';
      const L = computeLayout(badgeText, headline);
      // box
      ctx.fillStyle = '#FFD400'; ctx.fillRect(0, L.badgeY, L.badgeW, CONFIG.BADGE_HEIGHT);
      // badge text (Bebas)
      ctx.fillStyle = '#111';
      ctx.font = `400 ${CONFIG.BADGE_FONT_SIZE}px "Bebas Neue", Poppins, sans-serif`;
      // manual letter-spacing
      let x = CONFIG.BADGE_LEFT_PADDING; const ls = CONFIG.BADGE_LETTER_SPACING;
      for(let i=0;i<badgeText.length;i++){ const ch = badgeText[i]; ctx.fillText(ch, x, L.badgeY + CONFIG.BADGE_HEIGHT/2 + CONFIG.BADGE_FONT_SIZE*0.1); x += ctx.measureText(ch).width + (i<badgeText.length-1?ls:0); }
      // headline text (Roboto Bold Italic)
      ctx.fillStyle = '#fff'; ctx.font = `700 italic ${CONFIG.HEADLINE_FONT_SIZE}px Roboto, system-ui, sans-serif`;
      let y = L.yFirstBaseline; for(const ln of L.lines){ ctx.fillText(ln, CONFIG.HEADLINE_LEFT_PADDING, y); y += L.HL; }
      // download
      const link = document.createElement('a'); link.download = 'arte-manchete.png'; link.href = canvas.toDataURL('image/png'); link.click();
      // restore preview
      renderPreview();
    }

    // Sync between inputs and overlay
    function syncFromInputs(){
      els.badgeEdit.textContent = normalizeBadge(els.destaque.value || 'ALERTA');
      els.headlineEdit.textContent = els.manchete.value || '';
      renderPreview();
    }

    // Events
    els.destaque.addEventListener('input', syncFromInputs);
    els.manchete.addEventListener('input', syncFromInputs);

    let typingTimer; function onType(){
      clearTimeout(typingTimer); typingTimer = setTimeout(()=>{ renderPreview(); }, 60);
    }
    els.badgeEdit.addEventListener('input', ()=>{
      // uppercase & single line
      const v = normalizeBadge(els.badgeEdit.textContent);
      if(els.badgeEdit.textContent !== v){ els.badgeEdit.textContent = v; const sel = window.getSelection(); sel.selectAllChildren(els.badgeEdit); sel.collapseToEnd(); }
      els.destaque.value = v; onType();
    });
    els.headlineEdit.addEventListener('input', ()=>{ els.manchete.value = els.headlineEdit.textContent; onType(); });

    els.render.addEventListener('click', renderPreview);
    els.download.addEventListener('click', renderFinalAndDownload);
    els.clear.addEventListener('click', ()=>{
      els.destaque.value = 'ALERTA'; els.manchete.value = ''; els.upload.value = ''; bgURL = null;
      els.badgeEdit.textContent = 'ALERTA'; els.headlineEdit.textContent = '';
      renderPreview();
    });

    // boot
    (async()=>{ await ensureFonts(); syncFromInputs(); })();
  </script>
</body>
</html>
